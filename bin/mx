#!/bin/sh
username="yoshuawuyts"

get_session () {
  if [ -z "$1" ]; then
    # tmux 1.9a+ doesn't like .'s in session names
    pwd | awk -F"/" '{print $NF}'
  else
    c "$1"
    echo "$1" | awk -F"/" '{print $NF}'
  fi
}

# check if tmux needs to be booted up
tmux list-sessions | cut -d ':' -f 1 | grep '^_shared$' > /dev/null
if [ "$?" -ne 0 ]; then
  logpath="/Users/$USER/src/$username/knowledge"
  tmux new-session -d -s "_shared" -n 'log' -c "$logpath"
  tmux send-keys "$EDITOR" C-m
  tmux split-window -h -c "$logpath"
  tmux resize-pane -R 5

  confpath="/Users/$USER/src/$username/dotfiles"
  tmux new-window -n 'conf' -c "$confpath"
  tmux send-keys "$EDITOR" C-m
  tmux split-window -h -c "$confpath"
  tmux resize-pane -R 5
fi

SESSION="$(get_session "$1")"
tmux list-sessions | grep "^$SESSION$" > /dev/null
if [ "$?" -ne 0 ]; then
  if [ -d "$PROJECTS"/"$SESSION" ]; then
    cd "$PROJECTS"/"$SESSION" || exit 1
  fi
  tmux new-session -s "$SESSION" -d -n ''
  tmux send-keys "$EDITOR" C-m #':CtrlP' C-m
  tmux split-window -h
  tmux resize-pane -R 5
  tmux select-window -t "$SESSION"
  tmux link-window -s _shared:log -t 9
  tmux link-window -s _shared:conf -t 8
  tmux select-window -t 1
fi

if [ -z "$TMUX" ]; then
  tmux attach -t "$SESSION";
else
  tmux switch-client -t "$SESSION"
fi
